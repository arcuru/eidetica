# Forgejo CI workflow for code coverage
name: Coverage

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_VERSION: "1.92.0"

jobs:
  # Coverage for backends that don't need external services
  coverage:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        backend: [inmemory, sqlite]

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Cache Rust toolchain and dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.rustup
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/bin
            target
          key: ${{ runner.os }}-rust-${{ env.RUST_VERSION }}-coverage-${{ hashFiles('**/Cargo.lock', '**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-rust-${{ env.RUST_VERSION }}-coverage-
            ${{ runner.os }}-rust-${{ env.RUST_VERSION }}-

      - name: Install Rust
        uses: https://github.com/dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Install cargo-tarpaulin
        uses: https://github.com/taiki-e/install-action@v2
        with:
          tool: cargo-tarpaulin@0.34.1

      - name: Run coverage (inmemory)
        if: matrix.backend == 'inmemory'
        run: |
          cargo tarpaulin --verbose --all-features --out lcov --output-dir coverage --engine llvm

      - name: Run coverage (sqlite)
        if: matrix.backend == 'sqlite'
        run: |
          TEST_BACKEND=sqlite \
          cargo tarpaulin --verbose --all-features --out lcov --output-dir coverage --engine llvm

      - name: Upload coverage to Codecov
        uses: https://github.com/codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7 # v5
        continue-on-error: true
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: arcuru/eidetica
          flags: ${{ matrix.backend }}
          files: coverage/lcov.info
          fail_ci_if_error: false

  # PostgreSQL coverage uses service containers instead of docker run
  coverage-postgres:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: eidetica_test
          POSTGRES_HOST_AUTH_METHOD: trust
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Cache Rust toolchain and dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.rustup
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/bin
            target
          key: ${{ runner.os }}-rust-${{ env.RUST_VERSION }}-coverage-${{ hashFiles('**/Cargo.lock', '**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-rust-${{ env.RUST_VERSION }}-coverage-
            ${{ runner.os }}-rust-${{ env.RUST_VERSION }}-

      - name: Install Rust
        uses: https://github.com/dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Install cargo-tarpaulin
        uses: https://github.com/taiki-e/install-action@v2
        with:
          tool: cargo-tarpaulin@0.34.1

      - name: Run coverage (postgres)
        run: |
          TEST_BACKEND=postgres \
          TEST_POSTGRES_URL="postgres://postgres@postgres:5432/eidetica_test" \
          cargo tarpaulin --verbose --all-features --out lcov --output-dir coverage --engine llvm

      - name: Upload coverage to Codecov
        uses: https://github.com/codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7 # v5
        continue-on-error: true
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: arcuru/eidetica
          flags: postgres
          files: coverage/lcov.info
          fail_ci_if_error: false
