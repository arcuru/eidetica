name: Coverage (Nix)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@c5a866b6ab867e88becbed4467b93592bce69f8a # v21
      - name: Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@565684385bcd71bad329742eefe8d12f2e765b39 # v13

      - name: Build Coverage
        run: nix build .#coverage --print-build-logs

      # Extract coverage data from the Nix store
      - name: Extract Coverage Data
        run: |
          mkdir -p coverage
          cp -r $(nix path-info .#coverage)/* coverage/
          ls -la coverage/

      # Not uploading yet, testing this flow
      # - name: Upload coverage to Codecov
      #   uses: codecov/codecov-action@v4
      #   with:
      #     token: ${{ secrets.CODECOV_TOKEN }}
      #     files: coverage/lcov.info
      #     fail_ci_if_error: true
