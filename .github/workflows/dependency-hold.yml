# Required status check that blocks merging dependency update PRs during
# their hold period. Passes immediately for non-deps/ branches. For deps/
# branches, fails if the PR has the "on-hold" label. Works together with
# the Hold Expiry workflow, which removes the label when the hold expires
# and triggers a re-run of this check via the "unlabeled" event.
#
name: "Deps: Hold Gate"

on:
  pull_request:
    branches: ["main"]
    types: [opened, synchronize, reopened, labeled, unlabeled]

concurrency:
  group: deps-hold-gate-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  dependency-hold:
    name: Dependency Hold
    runs-on: ubuntu-latest
    steps:
      - name: Check hold status
        env:
          HEAD_REF: ${{ github.head_ref }}
          PR_LABELS: ${{ toJson(github.event.pull_request.labels.*.name) }}
        run: |
          # Pass immediately for non-dependency branches
          if [[ ! "$HEAD_REF" =~ ^deps/ ]]; then
            echo "Not a dependency branch, skipping hold check."
            exit 0
          fi

          echo "Dependency branch detected: $HEAD_REF"

          # Check for on-hold label
          if echo "$PR_LABELS" | jq -e 'index("on-hold")' > /dev/null 2>&1; then
            echo "::error::This dependency update is on hold. The on-hold label will be automatically removed after the hold period expires."
            exit 1
          fi

          echo "No hold in effect, dependency update may proceed."
