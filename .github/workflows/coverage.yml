name: Coverage

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # Coverage for backends that don't need external services
  coverage:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        backend: [sqlite, inmemory]

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.92.0

      - name: Rust Cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2

      - name: Install cargo-tarpaulin
        uses: taiki-e/install-action@650c5ca14212efbbf3e580844b04bdccf68dac31 # v2
        with:
          tool: cargo-tarpaulin@0.34.1

      - name: Run coverage (sqlite)
        if: matrix.backend == 'sqlite'
        run: |
          TEST_BACKEND=sqlite \
          cargo tarpaulin --verbose --all-features --out lcov --output-dir coverage --engine llvm

      - name: Run coverage (inmemory)
        if: matrix.backend == 'inmemory'
        run: |
          TEST_BACKEND=inmemory \
          cargo tarpaulin --verbose --all-features --out lcov --output-dir coverage --engine llvm

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: ${{ matrix.backend }}
          files: coverage/lcov.info
          fail_ci_if_error: true

  # PostgreSQL coverage uses service containers instead of docker run
  coverage-postgres:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:18-alpine@sha256:aa6eb304ddb6dd26df23d05db4e5cb05af8951cda3e0dc57731b771e0ef4ab29
        env:
          POSTGRES_DB: eidetica_test
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.92.0

      - name: Rust Cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2

      - name: Install cargo-tarpaulin
        uses: taiki-e/install-action@650c5ca14212efbbf3e580844b04bdccf68dac31 # v2
        with:
          tool: cargo-tarpaulin@0.34.1

      - name: Run coverage (postgres)
        run: |
          TEST_BACKEND=postgres \
          TEST_POSTGRES_URL="postgres://postgres@localhost:5432/eidetica_test" \
          cargo tarpaulin --verbose --all-features --out lcov --output-dir coverage --engine llvm

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: postgres
          files: coverage/lcov.info
          fail_ci_if_error: true
